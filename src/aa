import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import net.jpmchase.caminterns.model.Pool;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpHeaders;
import org.springframework.http.HttpMethod;
import org.springframework.http.HttpStatus;
import org.springframework.http.HttpEntity;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Service;
import org.springframework.web.client.RestTemplate;

import java.util.ArrayList;
import java.util.List;

@Service
public class PoolApiService {

    private final RestTemplate restTemplate;
    private final Logger log = LoggerFactory.getLogger(PoolApiService.class);
    private final String apiUrl = "http://pile-status-api-puliced.jpmchase.net/api/v2/products/app/pools";

    @Autowired
    public PoolApiService(RestTemplate restTemplate) {
        this.restTemplate = restTemplate;
    }

    public ResponseEntity<List<Pool>> getFilteredPoolRepos() {
        HttpHeaders headers = new HttpHeaders();
        headers.set("Accept", "application/json, text/plain, */*");
        HttpEntity<String> entity = new HttpEntity<>(headers);
        try {
            ResponseEntity<JsonNode> response = restTemplate.exchange(apiUrl, HttpMethod.GET, entity, JsonNode.class);
            if (response.getStatusCode().is2xxSuccessful() && response.getBody() != null) {
                JsonNode responseBody = response.getBody();
                List<Pool> filteredPools = processResponse(responseBody.get("regions"));
                return ResponseEntity.ok(filteredPools);
            } else {
                log.error("Failed to get pool info: " + response.getStatusCode());
                return ResponseEntity.status(response.getStatusCode()).build();
            }
        } catch (Exception e) {
            log.error("Error retrieving the pool: " + e.getMessage(), e);
            return ResponseEntity.status(HttpStatus.INTERNAL_SERVER_ERROR).build();
        }
    }

    private List<Pool> processResponse(JsonNode regionsNode) {
        List<Pool> filteredPools = new ArrayList<>();
        ObjectMapper objectMapper = new ObjectMapper();
        for (JsonNode regionNode : regionsNode) {
            for (JsonNode poolNode : regionNode.get("pools")) {
                if ("Strategic".equals(poolNode.get("dataCenterType").asText())) {
                    boolean hasDevInstance = false;
                    for (JsonNode instanceNode : poolNode.get("instances")) {
                        if ("dev".equals(instanceNode.get("env").asText())) {
                            hasDevInstance = true;
                            break;
                        }
                    }
                    if (hasDevInstance) {
                        Pool pool = objectMapper.convertValue(poolNode, Pool.class);
                        filteredPools.add(pool);
                    }
                }
            }
        }
        filteredPools.sort((p1, p2) -> {
            int available1 = p1.getInstances().stream()
                    .mapToInt(instance -> instance.getCapacity().getAvailable())
                    .sum();
            int available2 = p2.getInstances().stream()
                    .mapToInt(instance -> instance.getCapacity().getAvailable())
                    .sum();
            return Integer.compare(available2, available1); // sort in descending order
        });
        return filteredPools;
    }
}
Pool.java
Ensure your Pool model class contains nested classes for Instance and Capacity:

java
Copy code
package net.jpmchase.caminterns.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.Data;

import java.util.List;

@Data
public class Pool {
    @JsonProperty("pool")
    private String poolName;
    @JsonProperty("dataCenterType")
    private String dataCenterType;
    private List<Instance> instances;

    @Data
    public static class Instance {
        private String env;
        private Capacity capacity;

        @Data
        public static class Capacity {
            private int available;
        }
    }
}
